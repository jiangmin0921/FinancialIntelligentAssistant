# 邮件发送功能说明

## 功能概述

财务助手现在支持通过 SMTP 服务器实际发送邮件，而不仅仅是生成邮件内容。Agent 可以根据用户需求自动发送邮件，例如：
- 发送报销申请邮件给 HR
- 发送审批通知邮件
- 发送报销状态更新邮件

## 配置说明

### 1. 编辑 config.yaml

在 `config.yaml` 文件中添加邮件配置：

```yaml
email:
  smtp_host: "smtp.example.com"  # SMTP 服务器地址
  smtp_port: 587  # SMTP 端口
  smtp_user: "your_email@example.com"  # SMTP 用户名
  smtp_password: "your_password"  # SMTP 密码或授权码
  from_email: "your_email@example.com"  # 发件人邮箱
  from_name: "财务助手"  # 发件人显示名称
  use_tls: true  # 是否使用 TLS
```

### 2. 常见邮箱服务商配置

#### QQ 邮箱

```yaml
email:
  smtp_host: "smtp.qq.com"
  smtp_port: 587
  smtp_user: "your_qq@qq.com"
  smtp_password: "授权码"  # 需要在 QQ 邮箱设置中生成授权码
  from_email: "your_qq@qq.com"
  from_name: "财务助手"
  use_tls: true
```

**获取 QQ 邮箱授权码：**
1. 登录 QQ 邮箱
2. 设置 → 账户 → 开启 SMTP 服务
3. 生成授权码

#### Gmail

```yaml
email:
  smtp_host: "smtp.gmail.com"
  smtp_port: 587
  smtp_user: "your_email@gmail.com"
  smtp_password: "应用专用密码"  # 需要启用两步验证并生成应用专用密码
  from_email: "your_email@gmail.com"
  from_name: "财务助手"
  use_tls: true
```

**获取 Gmail 应用专用密码：**
1. 登录 Google 账户
2. 安全性 → 两步验证 → 应用专用密码
3. 生成新的应用专用密码

#### 163 邮箱

```yaml
email:
  smtp_host: "smtp.163.com"
  smtp_port: 465
  smtp_user: "your_email@163.com"
  smtp_password: "授权码"
  from_email: "your_email@163.com"
  from_name: "财务助手"
  use_tls: false  # 465 端口使用 SSL，不需要 TLS
```

**获取 163 邮箱授权码：**
1. 登录 163 邮箱
2. 设置 → POP3/SMTP/IMAP → 开启 SMTP 服务
3. 生成授权码

#### 企业邮箱（示例：阿里云企业邮箱）

```yaml
email:
  smtp_host: "smtp.mxhichina.com"  # 请根据实际企业邮箱服务商调整
  smtp_port: 465
  smtp_user: "your_email@company.com"
  smtp_password: "your_password"
  from_email: "your_email@company.com"
  from_name: "财务助手"
  use_tls: false
```

## 使用方法

### 1. 通过 Agent 自动发送

Agent 会自动识别用户意图，并在需要时调用邮件发送工具：

```python
from rag_system.agent.unified_agent import UnifiedFinancialAgent

agent = UnifiedFinancialAgent(verbose=True)

# 示例：发送报销申请邮件
result = agent.run(
    "我想申请差旅报销，请帮我查询一下差旅费报销的标准，"
    "然后帮我写一封邮件发给 HR 部门（hr@company.com），"
    "主题是'差旅费报销申请'，说明我想申请报销并询问具体流程。"
)

print(result["answer"])
```

### 2. 直接调用邮件工具

```python
from mcp.mcp_tools import send_email_tool

result = send_email_tool(
    to_email="recipient@example.com",
    subject="邮件主题",
    body="邮件正文内容",
    cc_email="cc@example.com",  # 可选：抄送
    bcc_email="bcc@example.com",  # 可选：密送
    is_html=False  # 可选：是否为 HTML 格式
)

print(result)
```

### 3. 测试邮件发送

运行测试脚本：

```bash
python mcp/test_email_tool.py
```

## 工具参数说明

### send_email_tool 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `to_email` | str | 是 | 收件人邮箱地址 |
| `subject` | str | 是 | 邮件主题 |
| `body` | str | 是 | 邮件正文内容 |
| `cc_email` | str | 否 | 抄送邮箱（多个用逗号分隔） |
| `bcc_email` | str | 否 | 密送邮箱（多个用逗号分隔） |
| `is_html` | bool | 否 | 是否为 HTML 格式，默认 False |

## 功能特性

1. **自动识别收件人**：Agent 可以从用户输入中提取收件人信息
2. **支持 HTML 格式**：可以发送格式化的 HTML 邮件
3. **支持抄送和密送**：支持多个收件人、抄送、密送
4. **错误处理**：提供详细的错误信息，帮助排查问题
5. **配置验证**：自动检查配置是否完整

## 常见问题

### Q1: 邮件发送失败，提示"SMTP 认证失败"

**A:** 请检查：
1. `smtp_user` 和 `smtp_password` 是否正确
2. 是否使用了授权码而非邮箱密码（QQ、163 等需要授权码）
3. Gmail 需要使用应用专用密码，而非账户密码

### Q2: 邮件发送失败，提示"连接超时"

**A:** 请检查：
1. `smtp_host` 和 `smtp_port` 是否正确
2. 网络连接是否正常
3. 防火墙是否阻止了 SMTP 连接

### Q3: 邮件发送失败，提示"收件人地址被拒绝"

**A:** 请检查：
1. 收件人邮箱地址格式是否正确
2. 收件人邮箱是否存在
3. 是否被邮件服务器标记为垃圾邮件

### Q4: 如何发送 HTML 格式的邮件？

**A:** 设置 `is_html=True`：

```python
send_email_tool(
    to_email="recipient@example.com",
    subject="HTML 邮件",
    body="<html><body><h1>这是 HTML 邮件</h1></body></html>",
    is_html=True
)
```

## 安全建议

1. **不要将密码提交到版本控制系统**：建议使用环境变量或配置文件（已加入 .gitignore）
2. **使用授权码而非密码**：对于支持授权码的邮箱服务商，使用授权码更安全
3. **限制发件权限**：确保只有授权用户可以配置和使用邮件发送功能
4. **定期更换密码**：定期更新 SMTP 密码或授权码

## 示例场景

### 场景 1: 发送报销申请邮件

```
用户：我想申请差旅报销，请帮我查询一下差旅费报销的标准，然后帮我写一封邮件发给 HR 部门（hr@company.com），主题是'差旅费报销申请'。

Agent 执行步骤：
1. 使用 rag_search 查询差旅费报销标准
2. 生成邮件内容（包含报销标准信息）
3. 使用 send_email 工具发送邮件给 hr@company.com
```

### 场景 2: 发送报销状态通知

```
用户：帮我查询一下张三的报销状态，然后发邮件通知他（zhangsan@company.com）。

Agent 执行步骤：
1. 使用 query_employee_info 查询张三的工号
2. 使用 query_reimbursement_status 查询报销状态
3. 生成通知邮件内容
4. 使用 send_email 工具发送邮件给 zhangsan@company.com
```

## 相关文件

- `mcp/mcp_tools.py` - 邮件发送工具实现
- `rag_system/agent/unified_agent.py` - Agent 集成邮件工具
- `config.yaml` - 邮件配置
- `mcp/test_email_tool.py` - 邮件发送测试脚本
- `rag_system/agent/unified_agent_example.py` - Agent 使用示例（包含邮件发送）

